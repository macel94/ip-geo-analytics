name: Deploy to Azure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
  push:
    branches:
      - main
    tags:
      - 'v*'

env:
  AZURE_RESOURCE_GROUP: rg-visitor-analytics
  AZURE_LOCATION: eastus
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Resource Group
        run: |
          az group create \
            --name ${{ env.AZURE_RESOURCE_GROUP }} \
            --location ${{ env.AZURE_LOCATION }}

      - name: Deploy Bicep Template
        uses: azure/arm-deploy@v2
        with:
          resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
          template: ./deploy/main.bicep
          parameters: dbPassword=${{ secrets.DB_PASSWORD }}
          failOnStdErr: false

  deploy-application:
    name: Deploy Application
    needs: deploy-infrastructure
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get Container App Name
        id: get-app
        run: |
          APP_NAME=$(az containerapp list \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "[0].name" -o tsv)
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT

      - name: Update Container App
        run: |
          az containerapp update \
            --name ${{ steps.get-app.outputs.app_name }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: Verify Deployment
        run: |
          APP_URL=$(az containerapp show \
            --name ${{ steps.get-app.outputs.app_name }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" -o tsv)
          echo "Application URL: https://$APP_URL"
          
          # Wait for app to be ready
          sleep 30
          
          # Check health endpoint
          curl -f https://$APP_URL/health || exit 1
