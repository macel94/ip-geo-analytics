name: Deploy to Azure Container Apps

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
  push:
    tags:
      - 'v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  AZURE_RESOURCE_GROUP: rg-ip-geo-analytics
  AZURE_LOCATION: westeurope

jobs:
  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    permissions:
      contents: read
      packages: read
    
    outputs:
      app_url: ${{ steps.deploy.outputs.app_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Resource Group
        run: |
          az group create \
            --name ${{ env.AZURE_RESOURCE_GROUP }} \
            --location ${{ env.AZURE_LOCATION }} \
            --output none || true

      - name: Deploy Infrastructure with Bicep
        id: deploy
        run: |
          # Deploy using Bicep
          # Note: Registry credentials are omitted since images are public on GHCR
          DEPLOYMENT_OUTPUT=$(az deployment group create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --template-file infra/main.bicep \
            --parameters \
              location=${{ env.AZURE_LOCATION }} \
              environment=${{ github.event.inputs.environment || 'staging' }} \
              imageTag=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ github.sha }} \
              registryServer=${{ env.REGISTRY }} \
              postgresPassword=${{ secrets.POSTGRES_PASSWORD || 'analytics123' }} \
            --query 'properties.outputs' \
            -o json)
          
          # Extract app URL from deployment outputs
          APP_URL=$(echo "$DEPLOYMENT_OUTPUT" | jq -r '.appUrl.value')
          echo "app_url=$APP_URL" >> $GITHUB_OUTPUT
          echo "Application URL: $APP_URL"

  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    environment: ${{ github.event.inputs.environment || 'staging' }}
    # Explicitly set empty permissions for security - this job only makes HTTP requests
    # and doesn't need any GitHub API access
    permissions: {}

    steps:
      - name: Check health endpoint
        run: |
          APP_URL="${{ needs.deploy.outputs.app_url }}"
          echo "Checking health at: $APP_URL/health"
          
          # Retry up to 10 times with 45 second intervals (7.5 minutes total)
          # This allows time for:
          # - Azure Container Apps to spin up from scale-to-zero
          # - Container startup and database connection
          # - Prisma migrations to run
          for i in {1..10}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 15 "$APP_URL/health" || echo "000")
            echo "Attempt $i: HTTP $HTTP_CODE"
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✅ Health check passed!"
              exit 0
            fi
            
            if [ $i -lt 10 ]; then
              echo "Waiting 45 seconds before retry..."
              sleep 45
            fi
          done
          
          echo "❌ Health check failed after 10 attempts"
          exit 1

      - name: Check readiness endpoint
        run: |
          APP_URL="${{ needs.deploy.outputs.app_url }}"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL/ready")
          echo "Readiness check: HTTP $HTTP_CODE"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "⚠️ Readiness check returned non-200 status"
          fi

      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Deployment Successful!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Application URL | ${{ needs.deploy.outputs.app_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment || 'staging' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | sha-${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | ${{ env.AZURE_RESOURCE_GROUP }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment Method**: Bicep Infrastructure as Code" >> $GITHUB_STEP_SUMMARY
          echo "- **App container**: scale-to-zero enabled (0-3 replicas)" >> $GITHUB_STEP_SUMMARY
          echo "- **PostgreSQL container**: scale-to-zero enabled (0-1 replicas) with internal ingress and Azure Files persistent storage" >> $GITHUB_STEP_SUMMARY
          echo "- **Storage**: Azure Files share mounted at /var/lib/postgresql/data" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Cost Information" >> $GITHUB_STEP_SUMMARY
          echo "- Free tier quota: 180k vCPU-sec, 360k GiB-sec/month" >> $GITHUB_STEP_SUMMARY
          echo "- Storage: ~$0.06/GB/month for Azure Files Standard" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Data persists across container restarts" >> $GITHUB_STEP_SUMMARY
